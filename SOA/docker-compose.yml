services:
  mysql:
    image: mysql:8.0
    container_name: mysql
    ports:
      - "3307:3306"
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: user_service_db,course_service_db,enrollment_service_db
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - soa-network
    restart: always

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: rabbitmq
    environment:
      # Tạo tài khoản admin thay cho guest để không bị chặn loopback
      - RABBITMQ_DEFAULT_USER=admin
      - RABBITMQ_DEFAULT_PASS=admin
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - soa-network
    restart: always

  discovery-service:
    image: soa-discovery-service:latest
    container_name: soa-discovery-service
    build:
      context: ./discovery-service
      dockerfile: Dockerfile
    ports:
      - "8761:8761"
    networks:
      - soa-network
    depends_on:
      - config-service
    restart: always

  config-service:
    image: soa-config-service:latest
    container_name: soa-config-service
    build:
      context: ./config-service
      dockerfile: Dockerfile
    ports:
      - "8888:8888"
    networks:
      - soa-network
    restart: always

  api-gateway:
    image: soa-api-gateway:latest
    container_name: soa-api-gateway
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      SPRING_CONFIG_IMPORT: optional:configserver:http://config-service:8888
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://discovery-service:8761/eureka/
    depends_on:
      - discovery-service
      - config-service
    networks:
      - soa-network
    restart: always

  user-service:
    image: soa-user-service:latest
    container_name: soa-user-service
    build:
      context: ./user-service
      dockerfile: Dockerfile
    ports:
      - "8081:8081"
    environment:
      # Tắt config server để tránh lỗi connection refused lúc khởi động
      SPRING_CLOUD_CONFIG_ENABLED: "false"
      EUREKA_CLIENT_ENABLED: "false"

      # Cấu hình DB cứng
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/user_service_db?createDatabaseIfNotExist=true&useSSL=false&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root

      # Cấu hình RabbitMQ
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
    depends_on:
      - mysql
      - rabbitmq
    networks:
      - soa-network
    restart: always
  course-service:
    image: soa-course-service:latest
    container_name: soa-course-service
    build:
      context: ./course-service
      dockerfile: Dockerfile
    ports:
      - "8082:8082"
    # [FIX] Thêm volume để lưu trữ ảnh/video bền vững
    volumes:
      - ./uploads_data:/app/uploads
    environment:
      SPRING_CONFIG_IMPORT: optional:configserver:http://config-service:8888
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://discovery-service:8761/eureka/
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/course_service_db?createDatabaseIfNotExist=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root
      spring.cloud.config.retry.initial-interval: 3000
      spring.cloud.config.retry.max-attempts: 10
    depends_on:
      - mysql
      - discovery-service
      - config-service
    networks:
      - soa-network
    restart: always

  payment-service:
    image: soa-payment-service:latest
    container_name: soa-payment-service
    build:
      context: ./payment-service
      dockerfile: Dockerfile
    ports:
      - "8083:8083"
    environment:
      SPRING_CONFIG_IMPORT: optional:configserver:http://config-service:8888
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://discovery-service:8761/eureka/
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
    depends_on:
      - discovery-service
      - config-service
      - rabbitmq
    networks:
      - soa-network
    restart: always

  enrollment-service:
    image: soa-enrollment-service:latest
    container_name: soa-enrollment-service
    build:
      context: ./enrollment-service
      dockerfile: Dockerfile
    ports:
      - "8084:8084"
    environment:
      SPRING_CONFIG_IMPORT: optional:configserver:http://config-service:8888
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://discovery-service:8761/eureka/
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/enrollment_service_db?createDatabaseIfNotExist=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
    depends_on:
      - mysql
      - discovery-service
      - config-service
      - rabbitmq
    networks:
      - soa-network
    restart: always

  notification-service:
    image: soa-notification-service:latest
    container_name: soa-notification-service
    build:
      context: ./notification-service
      dockerfile: Dockerfile
    ports:
      - "8085:8085"
    environment:
      SPRING_CONFIG_IMPORT: optional:configserver:http://config-service:8888
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://discovery-service:8761/eureka/
      RABBIT_HOST: rabbitmq
      RABBIT_PORT: 5672
      RABBIT_USERNAME: admin
      RABBIT_PASSWORD: admin
    depends_on:
      - discovery-service
      - config-service
      - rabbitmq
    networks:
      - soa-network
    restart: always

volumes:
  mysql-data:

networks:
  soa-network:
    driver: bridge
